name: Deploy Dashboards

# Triggered after Coolify successfully deploys the project.
# Runs automatically after Coolify finishes a deploy **or** on demand.
on:
  # Auto-deploy whenever a dashboard JSON is changed in this repo
  push:
    branches: [main]
    paths:
      - 'monitoring/dashboards/**'

  # Triggered externally (e.g., by Coolify) – kept for completeness
  repository_dispatch:
    types: [coolify-deployed]

  # Manual trigger in the GitHub UI – useful for testing.
  workflow_dispatch:

jobs:
  deploy-dashboards:
    runs-on: ubuntu-latest

    steps:
      # Check out the current project (required by composite action).
      - uses: actions/checkout@v4
        with:
          persist-credentials: false  # don't pollute git creds with GITHUB_TOKEN

      # Deploy dashboards to Grafana via the lightweight Python helper.
      - name: Deploy dashboards to Grafana
        run: |
          pip install --disable-pip-version-check --quiet requests
          python scripts/deploy_dashboards.py monitoring/dashboards
        env:
          GRAFANA_URL: ${{ secrets.GRAFANA_URL }}
          GRAFANA_API_KEY: ${{ secrets.GRAFANA_API_KEY }}
