{% extends "base.html" %}

{% block title %}Stop Sign Nanny{% endblock %}

{% block json_ld %}
<script type="application/ld+json">{{ json_ld | tojson }}</script>
{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest" defer></script>
<script src="/static/js/video-player.js" defer></script>
<script src="/static/js/home.js" defer></script>
{% endblock %}

{% block content %}
{# Single window that fills the viewport #}
<div class="window" style="height: calc(100vh - 62px);">
    <div class="title-bar">
        <span class="title-bar-text">Stop Sign Nanny &mdash; Crestwood Intersection</span>
        <div style="display: flex; align-items: center; gap: 6px;">
            <span style="display: flex; align-items: center; gap: 3px;">
                <span style="width: 6px; height: 6px; border-radius: 50%; background: var(--ok);" class="live-pulse"></span>
                <span style="font-size: 11px;">Live</span>
            </span>
        </div>
        <div class="title-bar-controls">
            <button>&#9472;</button>
            <button>&#9723;</button>
        </div>
    </div>

    {# Main content area — video left, passes right #}
    <div style="display: flex; flex: 1; overflow: hidden; margin: 2px; gap: 0;">
        {# Left: Video + stats strip stacked #}
        <div style="display: flex; flex-direction: column; flex: 1; min-width: 0;">
            {# Video — fills available space #}
            <div id="videoContainer"
                 hx-get="/load-video"
                 hx-trigger="load"
                 class="sunken-dark"
                 style="flex: 1; display: flex; align-items: center; justify-content: center; position: relative; min-height: 0;">
                <span style="color: var(--text-muted); font-size: 12px;" class="mono">Loading feed...</span>
            </div>

            {# Stats — horizontal strip below video #}
            <div class="raised" style="display: flex; align-items: center; gap: 0; padding: 0; flex-shrink: 0; border-top: none;">
                <div style="padding: 3px 10px; border-right: 1px solid var(--shadow);">
                    <span style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Compliance</span>
                    <span class="mono" style="font-size: 15px; font-weight: 700; margin-left: 4px;" id="complianceRate">--</span>
                </div>
                <div style="padding: 3px 10px; border-right: 1px solid var(--shadow);">
                    <span style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Violations</span>
                    <span class="mono" style="font-size: 13px; font-weight: 600; color: var(--bad); margin-left: 4px;" id="violationCount">--</span>
                    <span style="font-size: 9px; color: var(--text-muted);">24h</span>
                </div>
                <div style="padding: 3px 10px; border-right: 1px solid var(--shadow);">
                    <span style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Vehicles</span>
                    <span class="mono" style="font-size: 13px; font-weight: 600; margin-left: 4px;" id="vehicleCount">--</span>
                    <span style="font-size: 9px; color: var(--text-muted);">24h</span>
                </div>
                <div style="padding: 3px 10px; border-right: 1px solid var(--shadow);">
                    <span style="font-size: 10px; color: var(--text-muted); text-transform: uppercase;">Last Seen</span>
                    <span class="mono" style="font-size: 12px; color: var(--ok); margin-left: 4px;" id="lastDetection">--</span>
                </div>
                <div style="padding: 3px 10px; flex: 1; font-size: 11px; color: var(--text-secondary);">
                    <span id="trendArrow">&rarr;</span>
                    <span id="rotatingInsight">Loading...</span>
                </div>
            </div>
        </div>

        {# Right: Recent passes table — scrollable, fills height #}
        <div style="width: 380px; flex-shrink: 0; display: flex; flex-direction: column; border-left: 1px solid var(--dark);">
            <div class="raised" style="padding: 2px 6px; font-size: 11px; font-weight: 700; border-bottom: 1px solid var(--shadow); flex-shrink: 0;">
                Recent Passes
            </div>
            <div class="sunken" style="flex: 1; overflow-y: auto; padding: 0;">
                <div id="recentPasses"
                     hx-get="/api/recent-vehicle-passes"
                     hx-trigger="load"
                     hx-swap="innerHTML">
                    <div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    {# Hidden stats updater #}
    <div id="statsUpdater"
         hx-get="/api/live-stats"
         hx-trigger="load, every 15s"
         hx-swap="none"
         hx-vals='{"update": "stats"}'
         style="display: none;"></div>
</div>
{% endblock %}

{% block scripts %}
<style>
    @media (max-width: 900px) {
        {# Stack vertically on narrow screens #}
        .window > div[style*="display: flex; flex: 1; overflow: hidden"] {
            flex-direction: column !important;
        }
        .window > div[style*="display: flex; flex: 1; overflow: hidden"] > div[style*="width: 380px"] {
            width: 100% !important;
            border-left: none !important;
            border-top: 1px solid var(--dark);
            max-height: 300px;
        }
    }
</style>
{% endblock %}
