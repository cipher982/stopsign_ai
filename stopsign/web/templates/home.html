{% extends "base.html" %}

{% block title %}Stop Sign Nanny{% endblock %}

{% block json_ld %}
<script type="application/ld+json">{{ json_ld | tojson }}</script>
{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest" defer></script>
<script src="/static/js/video-player.js" defer></script>
<script src="/static/js/home.js" defer></script>
{% endblock %}

{% block content %}
{# Single window that fills the viewport #}
<div class="window" style="height: calc(100vh - 62px);">
    <div class="title-bar">
        <span class="title-bar-text">Stop Sign Nanny &mdash; Crestwood Intersection</span>
        <div class="stream-status" id="streamStatus">
            <span class="stream-status-dot live-pulse"></span>
            <span class="stream-status-label">Connecting...</span>
        </div>
        <div class="title-bar-controls">
            <button aria-hidden="true" tabindex="-1">&#9472;</button>
            <button aria-hidden="true" tabindex="-1">&#9723;</button>
        </div>
    </div>

    {# Main content area — video left, passes right #}
    <div class="home-layout">
        {# Left: Hero + Video + stats strip stacked #}
        <div style="display: flex; flex-direction: column; flex: 1; min-width: 0;">
            {# Hero narrative #}
            <div class="hero-bar">
                <div class="hero-bar-text">
                    <strong>AI-powered stop sign monitoring in Crestwood, St. Louis.</strong>
                    Watch real-time vehicle detection, see who stops and who doesn't, and explore neighborhood traffic patterns.
                    <a href="/about" class="hero-link">How it works &rarr;</a>
                </div>
            </div>

            {# Video — fills available space #}
            <div id="videoContainer"
                 hx-get="/load-video"
                 hx-trigger="load"
                 class="sunken-dark"
                 style="flex: 1; display: flex; align-items: center; justify-content: center; position: relative; min-height: 0;">
                <span style="color: var(--text-muted); font-size: 13px;" class="mono">Loading feed...</span>
            </div>

            {# Stats — horizontal strip below video #}
            <div class="stats-strip raised" aria-live="polite">
                <div class="stats-strip-item">
                    <span class="stats-strip-label">Compliance</span>
                    <span class="mono stats-strip-value" id="complianceRate">--</span>
                    <span class="stats-strip-hint" title="Percentage of vehicles stopping for 2+ seconds in the last 100 passes">last 100</span>
                </div>
                <div class="stats-strip-item">
                    <span class="stats-strip-label">Violations</span>
                    <span class="mono stats-strip-value" style="color: var(--bad);" id="violationCount">--</span>
                    <span class="stats-strip-hint">24h</span>
                </div>
                <div class="stats-strip-item">
                    <span class="stats-strip-label">Vehicles</span>
                    <span class="mono stats-strip-value" id="vehicleCount">--</span>
                    <span class="stats-strip-hint">24h</span>
                </div>
                <div class="stats-strip-item">
                    <span class="stats-strip-label">Last Seen</span>
                    <span class="mono stats-strip-value stats-strip-value-sm" style="color: var(--ok);" id="lastDetection">--</span>
                </div>
                <div class="stats-strip-item stats-strip-insight">
                    <span id="trendArrow">&rarr;</span>
                    <span id="rotatingInsight">Loading...</span>
                </div>
            </div>
        </div>

        {# Right: Recent passes — scrollable, fills height #}
        <div class="recent-passes-panel">
            <div class="raised recent-passes-header">
                Recent Passes
            </div>
            <div class="sunken" style="flex: 1; overflow-y: auto; padding: 0;">
                <div id="recentPasses"
                     hx-get="/api/recent-vehicle-passes"
                     hx-trigger="load"
                     hx-swap="innerHTML"
                     aria-live="polite">
                    <div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 13px;">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    {# Hidden stats updater #}
    <div id="statsUpdater"
         hx-get="/api/live-stats"
         hx-trigger="load, every 15s"
         hx-swap="none"
         hx-vals='{"update": "stats"}'
         style="display: none;"></div>
</div>
{% endblock %}

{% block scripts %}
<style>
    @media (max-width: 900px) {
        .home-layout {
            flex-direction: column !important;
        }
        .recent-passes-panel {
            width: 100% !important;
            border-left: none !important;
            border-top: 1px solid var(--dark);
            max-height: 300px;
        }
    }
</style>
{% endblock %}
