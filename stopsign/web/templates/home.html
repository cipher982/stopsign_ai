{% extends "base.html" %}

{% block title %}Stop Sign Nanny{% endblock %}

{% block json_ld %}
<script type="application/ld+json">{{ json_ld | tojson }}</script>
{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest" defer></script>
<script src="/static/js/video-player.js" defer></script>
<script src="/static/js/home.js" defer></script>
{% endblock %}

{% block content %}
<div style="display: grid; grid-template-columns: 1fr 240px; gap: 8px;">
    {# Video window #}
    <div class="window">
        <div class="title-bar">
            <span class="title-bar-text">Live Feed &mdash; Crestwood Intersection</span>
            <div class="title-bar-controls">
                <button>&#9472;</button>
                <button>&#9723;</button>
            </div>
        </div>
        <div class="window-body-flush" style="position: relative;">
            <div id="videoContainer"
                 hx-get="/load-video"
                 hx-trigger="load"
                 class="sunken-dark"
                 style="display: flex; align-items: center; justify-content: center; min-height: 300px; aspect-ratio: 16/9;">
                <span style="color: var(--text-muted); font-size: 12px;" class="mono">Loading feed...</span>
            </div>
            <div style="position: absolute; top: 8px; left: 8px; display: flex; align-items: center; gap: 4px; background: rgba(0,0,0,0.7); padding: 2px 6px;">
                <span style="width: 6px; height: 6px; border-radius: 50%; background: var(--ok);" class="live-pulse"></span>
                <span style="font-size: 10px; color: #fff; text-transform: uppercase; letter-spacing: 0.05em;" class="mono">Live</span>
            </div>
        </div>
    </div>

    {# Stats window #}
    <div class="window">
        <div class="title-bar">
            <span class="title-bar-text">System Status</span>
            <div class="title-bar-controls">
                <button>&#9472;</button>
                <button>&#9723;</button>
            </div>
        </div>
        <div class="window-body" style="display: flex; flex-direction: column; gap: 8px; font-size: 12px;">
            {# Compliance #}
            <div>
                <div style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em;">Compliance</div>
                <div class="mono" style="font-size: 28px; font-weight: 700; color: var(--text);" id="complianceRate">--</div>
            </div>

            <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 0;">

            {# Violations #}
            <div class="stat-readout">
                <span class="stat-label">Violations</span>
                <span class="stat-value" style="color: var(--bad);" id="violationCount">--</span>
            </div>

            {# Vehicles #}
            <div class="stat-readout">
                <span class="stat-label">Vehicles</span>
                <span class="stat-value" id="vehicleCount">--</span>
            </div>

            {# Period #}
            <div class="stat-readout">
                <span class="stat-label">Period</span>
                <span class="stat-value" style="font-size: 11px;">24h</span>
            </div>

            <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 0;">

            {# Last Detected #}
            <div class="stat-readout">
                <span class="stat-label">Last Seen</span>
                <span class="stat-value" style="color: var(--ok); font-size: 11px;" id="lastDetection">--</span>
            </div>

            {# Trend / insight #}
            <div style="font-size: 11px; color: var(--text-secondary); margin-top: auto;">
                <span id="trendArrow">&rarr;</span>
                <span id="rotatingInsight">Loading...</span>
            </div>

            <div id="statsUpdater"
                 hx-get="/api/live-stats"
                 hx-trigger="load, every 15s"
                 hx-swap="none"
                 hx-vals='{"update": "stats"}'
                 style="display: none;"></div>
        </div>
    </div>
</div>

{# Recent Passes window #}
<div class="window" style="margin-top: 8px;">
    <div class="title-bar">
        <span class="title-bar-text">Recent Passes</span>
        <div style="display: flex; align-items: center; gap: 4px;">
            <span style="width: 6px; height: 6px; border-radius: 50; background: var(--ok);" class="live-pulse"></span>
            <span style="font-size: 11px;">Live</span>
        </div>
        <div class="title-bar-controls">
            <button>&#9472;</button>
            <button>&#9723;</button>
        </div>
    </div>
    <div class="window-body-flush">
        <div id="recentPasses"
             hx-get="/api/recent-vehicle-passes"
             hx-trigger="load"
             hx-swap="innerHTML">
            <div style="text-align: center; padding: 16px; color: var(--text-muted); font-size: 12px;">Loading recent passes...</div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    @media (max-width: 768px) {
        div[style*="grid-template-columns: 1fr 240px"] {
            grid-template-columns: 1fr !important;
        }
    }
</style>
{% endblock %}
