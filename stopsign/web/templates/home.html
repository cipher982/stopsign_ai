{% extends "base.html" %}

{% block title %}Stop Sign Nanny{% endblock %}

{% block json_ld %}
<script type="application/ld+json">{{ json_ld | tojson }}</script>
{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest" defer></script>
<script src="/static/js/video-player.js" defer></script>
<script src="/static/js/home.js" defer></script>
{% endblock %}

{% block content %}
{# Single window that fills the viewport #}
<div class="window home-window">
    <div class="title-bar">
        <span class="title-bar-text">Stop Sign Nanny &mdash; Crestwood Intersection</span>
        <div id="streamStatus" style="display: flex; align-items: center; gap: 3px;">
            <span style="width: 6px; height: 6px; border-radius: 50%; background: var(--ok);" class="live-pulse stream-status-dot"></span>
            <span style="font-size: 11px;" class="stream-status-label">Connecting...</span>
        </div>
        <div class="title-bar-controls">
            <button aria-hidden="true" tabindex="-1">&#9472;</button>
            <button aria-hidden="true" tabindex="-1">&#9723;</button>
        </div>
    </div>

    {# Main content area â€” control-room grid #}
    <div class="home-grid">
        <div class="home-left">
            <div class="home-panel raised">
                <div class="home-panel-title">Project</div>
                <div class="home-panel-body home-about">
                    <div class="home-tagline">
                        <strong>AI-powered stop sign monitoring in Crestwood, Birmingham.</strong>
                        Live vehicle detection with a public data feed for neighborhood safety.
                    </div>
                    <div class="home-about-link">
                        <a href="/about">How it works &rarr;</a>
                    </div>
                </div>
            </div>
            <div class="home-panel raised">
                <div class="home-panel-title">Snapshot</div>
                <div class="home-panel-body">
                    <div class="stat-grid" aria-live="polite">
                        <div class="stat-cell">
                            <div class="stat-label">Compliance</div>
                            <div class="stat-value mono" id="complianceRate">--</div>
                        </div>
                        <div class="stat-cell">
                            <div class="stat-label">Violations (24h)</div>
                            <div class="stat-value mono stat-bad" id="violationCount">--</div>
                        </div>
                        <div class="stat-cell">
                            <div class="stat-label">Vehicles (24h)</div>
                            <div class="stat-value mono" id="vehicleCount">--</div>
                        </div>
                        <div class="stat-cell">
                            <div class="stat-label">Last Seen</div>
                            <div class="stat-value mono stat-ok" id="lastDetection">--</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="home-panel home-video raised">
            <div class="home-panel-title">Live Feed</div>
            <div id="videoContainer"
                 hx-get="/load-video"
                 hx-trigger="load"
                 class="sunken-dark home-video-frame">
                <span style="color: var(--text-muted); font-size: 12px;" class="mono">Loading feed...</span>
            </div>
        </div>

        <div class="home-panel home-recents raised">
            <div class="home-panel-title">Recent Passes</div>
            <div class="home-panel-body home-recents-body sunken">
                <div id="recentPasses"
                     hx-get="/api/recent-vehicle-passes"
                     hx-trigger="load"
                     hx-swap="innerHTML"
                     aria-live="polite">
                    <div style="text-align: center; padding: 12px; color: var(--text-muted); font-size: 12px;">Loading...</div>
                </div>
            </div>
        </div>

        <div class="home-panel home-ticker raised">
            <span class="ticker-label">Trend</span>
            <span class="mono" id="trendArrow">&rarr;</span>
            <span id="rotatingInsight">Loading...</span>
        </div>
    </div>

    {# Hidden stats updater #}
    <div id="statsUpdater"
         hx-get="/api/live-stats"
         hx-trigger="load, every 15s"
         hx-swap="none"
         hx-vals='{"update": "stats"}'
         style="display: none;"></div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .home-window {
        height: calc(100vh - 62px);
    }

    .home-grid {
        display: grid;
        grid-template-columns: 260px minmax(0, 1fr) 360px;
        grid-template-rows: 1fr auto;
        gap: 2px;
        height: calc(100% - 4px);
        margin: 2px;
        min-height: 0;
    }

    .home-left {
        display: grid;
        grid-template-rows: auto 1fr;
        gap: 2px;
        min-height: 0;
    }

    .home-panel {
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .home-panel-title {
        padding: 2px 6px;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.4px;
        border-bottom: 1px solid var(--shadow);
        background: var(--face);
    }

    .home-panel-body {
        padding: 6px;
        flex: 1;
        min-height: 0;
        overflow: auto;
    }

    .home-about {
        font-size: 12px;
        color: var(--text-secondary);
    }

    .home-tagline strong {
        color: var(--text);
    }

    .home-about-link {
        margin-top: 4px;
    }

    .stat-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 6px;
    }

    .stat-cell {
        background: var(--face);
        border: 1px solid var(--shadow);
        box-shadow: inset 1px 1px 0 var(--hi), inset -1px -1px 0 var(--shadow);
        padding: 4px 6px;
    }

    .stat-label {
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        color: var(--text-secondary);
    }

    .stat-value {
        font-size: 16px;
        font-weight: 700;
    }

    .stat-bad { color: var(--bad); }
    .stat-ok { color: var(--ok); }

    .home-video-frame {
        flex: 1;
        min-height: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .home-recents-body {
        padding: 0;
        overflow: auto;
    }

    .home-recents .home-panel-body {
        padding: 0;
    }

    .home-ticker {
        grid-column: 1 / -1;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 4px 8px;
        font-size: 11px;
    }

    .home-ticker .ticker-label {
        font-size: 10px;
        text-transform: uppercase;
        color: var(--text-secondary);
        letter-spacing: 0.3px;
    }

    @media (max-width: 1200px) {
        .home-grid {
            grid-template-columns: 220px minmax(0, 1fr);
            grid-template-rows: auto 1fr auto;
        }
        .home-recents {
            grid-column: 1 / -1;
            min-height: 220px;
            max-height: 280px;
        }
    }

    @media (max-width: 800px) {
        .home-grid {
            grid-template-columns: 1fr;
            grid-template-rows: auto auto auto auto;
        }
        .home-left {
            grid-template-rows: auto auto;
        }
        .home-recents {
            min-height: 200px;
            max-height: 260px;
        }
    }
</style>
{% endblock %}
